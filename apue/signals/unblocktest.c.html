<html>
<!-- -*- html -*- -->





<head>
  <title> ./apue/signals/unblocktest.c </title>
</head>

<body>

  <h1> <a href="../../.">.</a>/<a href="../.">apue</a>/<a href=".">signals</a>/unblocktest.c </h1>

  <a href="unblocktest.c">download original</a>

  <pre>
#include &lt;signal.h&gt;
#include &lt;setjmp.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;

void check_sigmask(const char *msg) {
    sigset_t ss;
    sigprocmask(0, 0, &amp;ss);
    printf("%s: SIGINT blocked: %i\n", msg, sigismember(&amp;ss, SIGINT));
}

sigjmp_buf jbuf;
volatile sig_atomic_t canjump = 0;

void sig_handler(int signum) {
    if (!canjump) {
        printf("too early signal\n");
        return;
    }
    check_sigmask("in sig handler");
    siglongjmp(jbuf, 1);
}


int main() {
    signal(SIGINT, sig_handler);

    for (volatile int i=0; i&lt;499999999; i++) { }  // busy loop to make it easier to trigger "too early signal" race

    check_sigmask("after handler initialization");

    if (1 == sigsetjmp(jbuf, 1)) {
        check_sigmask("after handler return");
    } else {
        canjump = 1;
        printf("waiting for SIGINT...\n");
        pause();
    }
}

/*
(OSX &amp; Linux)
$ ./unblocktest
after handler initialization: SIGINT blocked: 0
waiting for SIGINT...
^Cin sig handler: SIGINT blocked: 1
after handler return: SIGINT blocked: 0
$
*/

//19:55 &lt; multi_io_&gt; question: the automatic signal unblocking upon return from the signal handler -- how does that work if the handler isn't ended via sigreturn?
//19:55 &lt; multi_io_&gt; I just tested it, returned from the handler via longjmp. The signal still gets unblocked.

//=&gt;
// man siglongjmp:
 //      The sigsetjmp()/siglongjmp() function pairs save and restore the signal mask if the argument savemask is non-zero; otherwise, only the register set and the stack are saved.

  </pre>

  <a href="."> back to signals </a>

  <p/>

  <font size="-3">(C) 1998-2017 Olaf Klischat  &lt;olaf.klischat@gmail.com&gt; </font>

</body>

</html>
